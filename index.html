<!DOCTYPE html>          
<html lang="es">          
<head>          
    <meta charset="UTF-8">          
    <meta name="viewport" content="width=device-width, initial-scale=1.0">          
    <title>PC F√∫tbol Manager 2025/26</title>          
    <link rel="stylesheet" href="style.css">    
</head>          
<body>          
   <script type="module" src="./firebase-config.js"></script>      
   <script type="module" src="./injector-firebase-sync.js"></script>    
      
    <div class="header">    
        <div class="header-team-info">    
            <div class="team-slot team-slot-left">    
                <!-- ID cambiado a teamNameDisplay para ser m√°s consistente con la l√≥gica -->  
                <span id="teamNameDisplay"></span>    
                <!-- <span id="teamLocationDisplay">Guadix</span> No se usa en el JS actual, pero se puede mantener si se implementa -->  
            </div>    
            <div id="teamLogoLeft" class="team-logo-left"></div> <!-- Se usar√° para inyectar el logo del equipo -->  
        </div>    
        <div class="header-title">MENU PROMANAGER</div>    
        <div class="header-right-info">    
            <div class="date-box">    
                <!-- Estos elementos se actualizar√°n din√°micamente -->  
                <span id="currentDateMonth">Agosto</span>    
                <span id="currentDateDay">17</span>    
                <span id="currentDateWeekday">S√°bado</span>    
                <span id="currentDateYear">1996</span>    
            </div>    
            <div id="preseasonBox" class="preseason-box"> <!-- ID para control JS -->  
                <span>Pretemp.</span>    
                <span id="preseasonStatus">Preparaci√≥n</span>    
                <div class="ball-icon"></div>    
            </div>    
            <!-- Agregamos los info-box para el dinero y jornada, adaptando la clase para el estilo del date-box -->  
            <div class="info-box">Jornada: <span id="weekNo">1</span></div>  
            <div class="info-box">Dinero: <span id="balanceDisplay">0‚Ç¨</span></div>  
            <!-- Botones globales que se mantienen fuera del main-layout -->  
            <button class="btn btn-sm" onclick="window.saveCurrentGame()">üíæ Guardar</button>    
            <button class="btn btn-sm" onclick="window.openModal('gameMode')">Nuevo Juego</button>        
        </div>    
    </div>          
          
    <div class="main-layout" id="mainLayout"> <!-- A√±adido ID para ocultar/mostrar con JS -->  
        <div class="main-center-circle">    
            <div class="center-option cpu">CPU</div>    
            <div class="center-option">J.c. Alvarez</div>    
            <!-- Los siguientes ser√°n actualizados con la informaci√≥n real de los equipos -->  
            <div class="center-option selected-team">    
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Escudo_del_C%C3%A1diz_Club_de_F%C3%BAtbol.svg/1200px-Escudo_del_C%C3%A1diz_Club_de_F%C3%BAtbol.svg.png" alt="C√°diz Logo" class="team-logo">    
                C√°diz    
            </div>    
            <div class="center-option current-team">    
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Logo_Guadix_CF.png" alt="Guadix Logo" class="team-logo">    
                Guadix    
            </div>    
            <div class="center-option">Kalimero</div>    
            <div class="center-option">JUG 1</div>    
            <div class="arrow-down"></div>    
        </div>    
        <div class="quadrant top-left">    
            <div class="section-title">SEGUIMIENTO</div>    
            <button class="menu-button green-button results-icon" data-page-id="dashboard">RESULTADOS</button>    
            <button class="menu-button green-button classification-icon" data-page-id="standings">CLASIFICACION</button>    
            <button class="menu-button green-button calendar-icon" data-page-id="calendar">CALENDARIO</button>    
            <div class="action-buttons">    
                <button class="action-button logout-icon" onclick="window.resetGame()">SALIR</button>    
                <button class="action-button save-icon" onclick="window.saveCurrentGame()">GRABAR LIGA</button>    
            </div>    
        </div>    
        <div class="quadrant top-right">    
            <div class="section-title">ENTRENADOR</div>    
            <button class="menu-button blue-button lineup-icon" data-page-id="lineup">ALINEACI√ìN</button>    
            <button class="menu-button blue-button tactics-icon" data-page-id="tactics">TACTICAS</button>    
            <button class="menu-button blue-button rival-icon" data-page-id="match">VER RIVAL</button>    
            <div class="action-buttons">    
                <button class="action-button news-icon" data-page-id="dashboard">NOTICIAS</button>    
                <button class="action-button follow-icon" onclick="alert('Seguir no implementado')">SEGUIR</button>    
            </div>    
        </div>    
        <div class="quadrant bottom-left">    
            <div class="section-title">MERCADO</div>    
            <button class="menu-button red-button transfer-icon" data-page-id="transfers">FICHAR</button>    
            <button class="menu-button red-button squad-icon" data-page-id="squad">PLANTILLA</button>    
            <button class="menu-button red-button staff-icon" data-page-id="staff">EMPLEADOS</button>    
            <div class="action-buttons bottom-action-left">    
                <!-- Aqu√≠ podr√≠an ir otros botones relacionados con el mercado -->    
            </div>    
        </div>    
        <div class="quadrant bottom-right">    
            <div class="section-title">FINANZAS</div>    
            <button class="menu-button orange-button cash-icon" data-page-id="finance">CAJA</button>    
            <button class="menu-button orange-button decisions-icon" data-page-id="commercial">DECISIONES</button>    
            <button class="menu-button orange-button stadium-icon" data-page-id="facilities">ESTADIO</button>    
            <div class="action-buttons bottom-action-right">    
                <!-- Aqu√≠ podr√≠an ir otros botones relacionados con las finanzas -->    
            </div>    
        </div>    
        <div class="main-ball-decoration"></div>    
    </div>    
    
    <div class="content-pages" id="contentPages"> <!-- A√±adido ID para controlar su visibilidad -->  
        <!-- DASHBOARD -->          
        <div id="dashboard" class="page"> <!-- Removido .active inicial, lo controlar√° JS -->  
            <h1>üìä Dashboard del Club</h1>          
            <div id="warningAlert" style="display: none;"></div>          
            <div class="data-grid">          
                <div class="data-box">          
                    <div class="data-label">Posici√≥n</div>          
                    <div class="data-value" id="dashPos">-</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Puntos</div>          
                    <div class="data-value" id="dashPts">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">PJ</div>          
                    <div class="data-value" id="dashPJ">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Goles</div>          
                    <div class="data-value" id="dashGoals">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Jugadores</div>          
                    <div class="data-value" id="dashSquad">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Juveniles</div>          
                    <div class="data-value" id="dashAcademy">0</div>          
                </div>          
            </div>          
            <h2>Estado Financiero</h2>          
            <table>          
                <tr><td>Dinero en Caja:</td><td id="dashBalance">0‚Ç¨</td></tr>          
                <tr><td>Ingresos Semanales:</td><td id="dashIncome">0‚Ç¨</td></tr>          
                <tr><td>Gastos Semanales:</td><td id="dashExpenses">0‚Ç¨</td></tr>          
                <tr><td>Balance Semanal:</td><td id="dashWeekly" class="data-value">+0‚Ç¨</td></tr>          
            </table>          
            <h2>√öltimas Noticias</h2>          
            <div id="newsFeed">          
                <div class="alert alert-info">No hay noticias recientes.</div>          
            </div>          
        </div>          
      
        <!-- CLASIFICACI√ìN -->          
        <div id="standings" class="page">          
            <h1>üìà Clasificaci√≥n Liga</h1>          
            <table>          
                <thead><tr><th>Pos</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th><th>GF</th><th>GC</th><th>DG</th><th>Pts</th></tr></thead>          
                <tbody id="standingsTable"></tbody>          
            </table>          
        </div>          
      
        <!-- CALENDARIO -->          
        <div id="calendar" class="page">          
            <h1>üìÖ Calendario de Partidos</h1>          
            <div id="calendarContent">          
                <div class="alert alert-info">Aqu√≠ se mostrar√°n los partidos de tu divisi√≥n.</div>          
            </div>          
        </div>          
      
        <!-- PLANTILLA -->          
        <div id="squad" class="page">          
            <h1>üë• Plantilla</h1>          
            <div id="squadList" style="margin-top: 20px;"></div>          
        </div>          
      
        <!-- MERCADO -->          
        <div id="transfers" class="page">          
            <h1>üîÑ Mercado de Fichajes</h1>          
            <div class="alert alert-info">üí° Busca talentos j√≥venes para comprar barato y revender caro, o refuerza tu equipo.</div>          
            <h2>Buscar Jugadores</h2>          
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">          
                <input type="text" id="marketSearchName" placeholder="Nombre del jugador" style="width: 150px;">          
                <select id="marketPosition" style="width: 120px;">          
                    <option value="ALL">Posici√≥n</option>          
                    <!-- Opciones de posici√≥n se cargar√°n din√°micamente -->          
                </select>          
                <input type="number" id="marketMinOverall" placeholder="Media min." min="1" max="99" style="width: 100px;">          
                <input type="number" id="marketMaxAge" placeholder="Edad max." min="16" max="40" style="width: 100px;">          
                <label style="display:flex; align-items:center; gap: 5px;"><input type="checkbox" id="marketTransferListed" style="width:auto;"> Transferibles</label>          
                <label style="display:flex; align-items:center; gap: 5px;"><input type="checkbox" id="marketLoanListed" style="width:auto;"> Cedibles</label>          
                <button class="btn btn-sm" onclick="window.searchPlayersMarket()">Buscar</button>          
                <button class="btn btn-sm" style="background: #c73446;">Limpiar</button>          
            </div>          
            <div id="availablePlayersSearchResult" style="margin-top: 20px;">          
                <div class="alert alert-info">Utiliza los filtros de b√∫squeda para encontrar jugadores.</div>          
            </div>          
            <h2>Contratar J√≥venes de Cantera</h2>          
            <div id="availableYoungstersList" style="margin-top: 20px;"></div>          
        </div>          
      
        <!-- CANTERA -->          
        <div id="academy" class="page">          
            <h1>üéì Academia y Cantera</h1>          
            <button class="btn" onclick="window.openModal('signYoungster')">+ Contratar Joven de Mercado</button>          
            <div id="academyList" style="margin-top: 20px;"></div>          
        </div>          
      
        <!-- ALINEACI√ìN -->          
        <div id="lineup" class="page">          
            <h1>‚öΩ Alineaci√≥n</h1>          
            <p class="alert alert-info" id="lineupMessage">Arrastra y suelta jugadores para configurar tu alineaci√≥n. Los jugadores lesionados no pueden ser alineados.</p>          
            <div class="pitch-container" id="pitchContainer">          
                <!-- Aqu√≠ se renderizar√°n los 11 titulares -->          
            </div>          
            <div class="reserves-container">          
                <h2>Suplentes y No Convocados</h2>          
                <div class="reserves-list" id="reservesList">          
                    <!-- Aqu√≠ se renderizar√°n los suplentes -->          
                </div>          
            </div>          
            <button class="btn" style="margin-top: 20px;" onclick="window.saveLineup()">Guardar Alineaci√≥n</button>          
        </div>          
      
        <!-- T√ÅCTICAS -->          
        <div id="tactics" class="page">          
            <h1>üéØ T√°cticas</h1>          
            <div class="form-group" style="margin: 20px 0;">          
                <label style="display: block; margin-bottom: 5px;">Formaci√≥n:</label>          
                <select id="formationSelect" onchange="window.updateFormation()">          
                    <option value="433">4-3-3 Ofensiva</option>          
                    <option value="442">4-4-2 Cl√°sica</option>          
                    <option value="352">3-5-2 Ultra Ofensiva</option>          
                    <option value="541">5-4-1 Defensiva</option>          
                    <option value="451">4-5-1 Contenci√≥n</option>          
                </select>          
                <label style="display: block; margin-top: 15px; margin-bottom: 5px;">Mentalidad:</label>          
                <select id="mentalitySelect" onchange="window.updateMentality()">          
                    <option value="defensive">Defensiva</option>          
                    <option value="balanced" selected>Equilibrada</option>          
                    <option value="offensive">Ofensiva</option>          
                </select>          
            </div>          
        </div>          
      
        <!-- PR√ìXIMO PARTIDO -->          
        <div id="match" class="page">          
            <h1>‚öΩ Simular Jornada</h1>          
            <div id="matchInfo" style="margin: 30px 0;">          
                <!-- Aqu√≠ se mostrar√° la informaci√≥n del pr√≥ximo partido -->          
            </div>          
            <button class="btn" id="simulateWeekButton" onclick="window.simulateWeek()">Simular Jornada Completa</button>          
            <div id="lastMatchResult" style="margin-top: 20px;"></div>          
        </div>          
      
        <!-- FINANZAS -->          
        <div id="finance" class="page">          
            <h1>üíº Finanzas</h1>          
            <div class="data-grid">          
                <div class="data-box">          
                    <div class="data-label">Ingresos/Semana</div>          
                    <div class="data-value" id="financeWeeklyIncome">0‚Ç¨</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Gastos/Semana</div>          
                    <div class="data-value negative" id="financeWeeklyExpenses">0‚Ç¨</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Balance Actual</div>          
                    <div class="data-value" id="financeBalance">0‚Ç¨</div>          
                </div>          
            </div>          
            <h2>Detalle de Ingresos</h2>          
            <table>          
                <tr><td>Capacidad Estadio:</td><td id="financeStadiumCapacity">0</td></tr>          
                <tr><td>Asistencia Esperada:</td><td id="financeExpectedAttendance">0</td></tr>          
                <tr><td>Precio Entrada:</td><td><input type="number" id="ticketPriceInput" min="5" max="100" onchange="window.setTicketPriceFromInput()">‚Ç¨</td></tr>          
                <tr><td>Popularidad del Club:</td><td id="financePopularity">0%</td></tr>          
                <tr><td>Fanbase:</td><td id="financeFanbase">0</td></tr>          
                <tr><td>Merchandising vendido:</td><td id="financeMerchandisingItemsSold">0</td></tr>          
                <tr><td>Precio Merchandising:</td><td><input type="number" id="merchandisingPriceInput" min="1" max="50" onchange="window.setMerchandisingPriceFromInput()">‚Ç¨</td></tr>          
                <tr><td>Ingresos Merchandising:</td><td id="financeMerchandisingRevenue">0‚Ç¨</td></tr>          
            </table>          
        </div>          
      
       <!-- INSTALACIONES -->      
        <div id="facilities" class="page">      
            <h1>üèüÔ∏è Instalaciones</h1>      
                  
            <!-- Secci√≥n del Estadio -->      
            <div class="facility-section">      
                <h2>Estadio</h2>      
                <div class="stadium-details">      
                    <div>      
                        <p><strong>Nombre:</strong> <span id="stadiumNameDisplay">--</span></p>      
                        <p><strong>Capacidad actual:</strong> <span id="currentStadiumCapacity">0</span> espectadores</p>      
                        <button class="btn" onclick="window.expandStadium()">Expandir Estadio (+10.000 asientos - 50.000‚Ç¨)</button>      
                    </div>      
                    <div id="stadiumImageContainer">      
                        <p>No hay imagen del estadio disponible</p>      
                    </div>      
                </div>      
            </div>      
                  
            <!-- Secci√≥n del Centro de Entrenamiento -->      
            <div class="facility-section">      
                <h2>Centro de Entrenamiento</h2>      
                <p><strong>Nivel actual:</strong> <span id="currentTrainingLevel">1</span></p>      
                <p class="small-text">Un mejor centro de entrenamiento mejora la efectividad de los entrenamientos individuales</p>      
                <button class="btn" onclick="window.improveFacilities()">Mejorar Entrenamientos (30.000‚Ç¨)</button>      
            </div>      
        </div>      
      
        <!-- COMERCIAL (Nueva secci√≥n) -->          
        <div id="commercial" class="page">          
            <h1>üõí Gesti√≥n Comercial</h1>          
            <div class="data-grid">          
                <div class="data-box">          
                    <div class="data-label">Popularidad del Club</div>          
                    <div class="data-value" id="commercialPopularity">0%</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Base de Fans</div>          
                    <div class="data-value" id="commercialFanbase">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Merchandising Vendido (semana)</div>          
                    <div class="data-value" id="commercialItemsSold">0</div>          
                </div>          
                <div class="data-box">          
                    <div class="data-label">Ingresos Merchandising (semana)</div>          
                    <div class="data-value" id="commercialMerchRevenue">0‚Ç¨</div>          
                </div>          
            </div>          
            <h2>Ajustes Comerciales</h2>          
            <p>Ajusta el precio de tus entradas y merchandising para maximizar beneficios. Ten en cuenta que precios muy altos pueden reducir la popularidad y la asistencia.</p>          
            <div style="margin-top: 20px;">          
                <label style="display: block; margin-bottom: 5px;">Precio de la Entrada (actual: <span id="currentTicketPrice">0</span>‚Ç¨):</label>          
                <input type="range" id="ticketPriceSlider" min="5" max="100" value="20" oninput="window.updateTicketPriceDisplay(this.value)" onchange="window.setTicketPriceFromSlider(this.value)">          
                <span id="ticketPriceSliderValue">20</span>‚Ç¨          
            </div>          
            <div style="margin-top: 15px;">          
                <label style="display: block; margin-bottom: 5px;">Precio del Merchandising (actual: <span id="currentMerchandisingPrice">0</span>‚Ç¨):</label>          
                <input type="range" id="merchandisingPriceSlider" min="1" max="50" value="10" oninput="window.updateMerchandisingPriceDisplay(this.value)" onchange="window.setMerchandisingPriceFromSlider(this.value)">          
                <span id="merchandisingPriceSliderValue">10</span>‚Ç¨          
            </div>          
        </div>          
      
        <!-- STAFF -->          
        <div id="staff" class="page">          
            <h1>üëî Personal del Club</h1>          
            <table>          
                <thead><tr><th>Rol</th><th>Nombre</th><th>Nivel</th><th>Salario</th><th>Cl√°usula</th><th>Acciones</th></tr></thead>          
                <tbody>          
                    <tr><td>üè• M√©dico</td><td id="staffMedicoName"></td><td id="staffMedicoLevel"></td><td id="staffMedicoSalary"></td><td id="staffMedicoClausula"></td><td><button class="btn btn-sm" id="btnHireMedico" onclick="window.openHireStaffModal('medico')"></button></td></tr>          
                    <tr><td>üß™ Entrenador F√≠sico</td><td id="staffEntrenadorName"></td><td id="staffEntrenadorLevel"></td><td id="staffEntrenadorSalary"></td><td id="staffEntrenadorClausula"></td><td><button class="btn btn-sm" id="btnHireEntrenador" onclick="window.openHireStaffModal('entrenador')"></button></td></tr>          
                    <tr><td>‚öΩ Entrenador Porteros</td><td id="staffEntrenadorPorterosName"></td><td id="staffEntrenadorPorterosLevel"></td><td id="staffEntrenadorPorterosSalary"></td><td id="staffEntrenadorPorterosClausula"></td><td><button class="btn btn-sm" id="btnHireEntrenadorPorteros" onclick="window.openHireStaffModal('entrenadorPorteros')"></button></td></tr>          
                    <tr><td>ü©π Fisioterapeuta</td><td id="staffFisioName"></td><td id="staffFisioLevel"></td><td id="staffFisioSalary"></td><td id="staffFisioClausula"></td><td><button class="btn btn-sm" id="btnHireFisio" onclick="window.openHireStaffModal('fisio')"></button></td></tr>          
                    <tr><td>üé¨ Analista V√≠deo</td><td id="staffAnalistaName"></td><td id="staffAnalistaLevel"></td><td id="staffAnalistaSalary"></td><td id="staffAnalistaClausula"></td><td><button class="btn btn-sm" id="btnHireAnalista" onclick="window.openHireStaffModal('analista')"></button></td></tr>          
                    <tr><td>üîç Ojeador</td><td id="staffScoutName"></td><td id="staffScoutLevel"></td><td id="staffScoutSalary"></td><td id="staffScoutClausula"></td><td><button class="btn btn-sm" id="btnHireScout" onclick="window.openHireStaffModal('scout')"></button></td></tr>          
                    <tr><td>‚úçÔ∏è Secretario T√©cnico</td><td id="staffSecretarioName"></td><td id="staffSecretarioLevel"></td><td id="staffSecretarioSalary"></td><td id="staffSecretarioClausula"></td><td><button class="btn btn-sm" id="btnHireSecretario" onclick="window.openHireStaffModal('secretario')"></button></td></tr>          
                    <tr><td>üßë‚Äçüè´ Segundo Entrenador</td><td id="staffSegundoEntrenadorName"></td><td id="staffSegundoEntrenadorLevel"></td><td id="staffSegundoEntrenadorSalary"></td><td id="staffSegundoEntrenadorClausula"></td><td><button class="btn btn-sm" id="btnHireSegundoEntrenador" onclick="window.openHireStaffModal('segundoEntrenador')"></button></td></tr>          
                </tbody>          
            </table>          
        </div>          
      
        <!-- OPCIONES -->          
        <div id="settings" class="page">          
            <h1>‚öôÔ∏è Opciones</h1>          
            <button class="btn" onclick="window.saveGame()">üíæ Guardar Partida (Local)</button>          
            <button class="btn" onclick="window.loadGame()">üìÇ Cargar Partida (Local)</button>          
            <button class="btn danger" style="margin-top: 20px;" onclick="window.resetGame()">üîÑ Reiniciar</button>          
            <hr style="margin-top: 20px; border-color: rgba(85, 136, 255, 0.3);">      
            <h2>Opciones de la Nube</h2>      
            <button class="btn" id="cloudLoadButtonPlaceholder" onclick="alert('Funcionalidad de cargar desde la nube a√∫n no implementada.');">‚òÅÔ∏è Cargar de la Nube</button>      
            <p style="margin-top: 10px;">¬°Recuerda que para guardar en la nube, debes estar autenticado!</p>      
            <div id="firebaseStatusIndicatorContainer"></div>      
        </div>          
    </div>    
          
    <!-- MODALES -->          
    <div id="gameModeModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.closeModal('gameMode')">&times;</span>          
            <h1>Modo de Juego</h1>          
            <button class="btn" style="width: 100%; padding: 20px; margin-top: 20px;" onclick="window.startGameMode('manager')">üèÖ Liga Manager (Empezar con equipo preexistente)</button>          
            <button class="btn" style="width: 100%; padding: 20px; margin-top: 20px;" onclick="window.startGameMode('promanager')">üöÄ Liga Promanager (Empezar desde abajo)</button>          
        </div>          
    </div>          
          
    <div id="selectTeamModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.closeModal('selectTeam')">&times;</span>          
            <h1>Selecciona tu Equipo</h1>          
            <h2>Primera Divisi√≥n</h2>          
            <div id="primeraList" class="team-selection-list"></div>          
            <h2>Segunda Divisi√≥n</h2>          
            <div id="segundaList" class="team-selection-list"></div>          
            <h2>Primera RFEF Grupo 1</h2>          
            <div id="rfef_grupo1List" class="team-selection-list"></div>          
            <h2>Primera RFEF Grupo 2</h2>          
            <div id="rfef_grupo2List" class="team-selection-list"></div>          
        </div>          
    </div>          
          
    <div id="signYoungsterModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.closeModal('signYoungster')">&times;</span>          
            <h1>Contratar Joven</h1>          
            <div id="availableYoungstersList"></div>          
        </div>          
    </div>          
          
    <!-- MODAL DE NEGOCIACI√ìN -->          
    <div id="negotiationModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.endNegotiationUI(false)">&times;</span>          
            <h1>Negociaci√≥n de Fichajes</h1>          
          
            <div class="negotiation-player-info">          
                <h3><span id="negotiationPlayerName"></span> (<span id="negotiationPlayerClub"></span>)</h3>          
                <p>Posici√≥n: <span id="negotiationPlayerPosition"></span> | Edad: <span id="negotiationPlayerAge"></span> | Media: <span id="negotiationPlayerOverall"></span> | Potencial: <span id="negotiationPlayerPotential"></span></p>          
                <p>Salario Actual: <span id="negotiationPlayerCurrentSalary"></span>‚Ç¨/sem | Valor de Mercado: <span id="negotiationPlayerValue"></span>‚Ç¨</p>          
                <p id="negotiationPlayerAskingPrice" style="display: none;"><span style="color: orange; font-weight: bold;">Precio solicitado: <span id="negotiationPlayerAskingPriceValue"></span>‚Ç¨</span></p>          
                <p id="negotiationPlayerLoanInfo" style="display: none;"><span style="color: lightblue; font-weight: bold;">Cedible (club actual paga <span id="negotiationPlayerLoanContribution"></span>‚Ç¨/sem)</span></p>          
            </div>          
          
            <!-- PASO 1: Oferta al Jugador -->          
            <div id="negotiationStep1" class="negotiation-step">          
                <h2>Paso 1: Ofrecer Contrato Personal a <span id="negotiationPlayerNameStep1"></span></h2>          
                <label for="offeredSalary">Salario Semanal:</label>          
                <input type="number" id="offeredSalary" value="0" min="0" step="100">‚Ç¨          
          
                <div class="negotiation-incentives">          
                    <div><input type="checkbox" id="offeredBonus"><label for="offeredBonus">Prima por Fichaje</label></div>          
                    <div><input type="checkbox" id="offeredCar"><label for="offeredCar">Coche</label></div>          
                    <div><input type="checkbox" id="offeredHouse"><label for="offeredHouse">Casa</label></div>          
                    <div><input type="checkbox" id="offeredMerchPercent"><label for="offeredMerchPercent">% Merchandising</label></div>          
                    <div><input type="checkbox" id="offeredTicketPercent"><label for="offeredTicketPercent">% Entradas</label></div>          
                </div>          
                <button class="btn" onclick="window.submitPlayerOffer()">Hacer Oferta al Jugador</button>          
                <button class="btn danger" onclick="window.endNegotiationUI(false)">Cancelar Negociaci√≥n</button>          
            </div>          
          
            <!-- PASO 2: Oferta al Club -->          
            <div id="negotiationStep2" class="negotiation-step" style="display: none;">          
                <h2>Paso 2: Negociar con el Club <span id="negotiationPlayerClubStep2"></span></h2>          
                <p id="negotiationClubMessage"></p>          
          
                <!-- Si es cesi√≥n -->          
                <div id="negotiationLoanOffer" style="display: none;">          
                    <label for="loanWageContribution">¬øQu√© porcentaje de su salario semanal pagar√≠as? (Actual: <span id="loanPlayerSalaryExample"></span>‚Ç¨)</label>          
                    <input type="range" id="loanWageContribution" min="0" max="100" value="50" oninput="document.getElementById('loanWageContributionValue').textContent=this.value+'%'">          
                    <span id="loanWageContributionValue">50</span>%          
                    <p class="alert alert-info">El club de origen paga <span id="loanClubContributionInfo"></span>‚Ç¨ de su salario actual.</p>          
                    <button class="btn" onclick="window.submitLoanOffer()">Hacer Oferta de Cesi√≥n</button>          
                </div>          
          
                <!-- Si es traspaso -->          
                <div id="negotiationTransferOffer" style="display: none;">          
                    <label for="offerAmount">Cantidad de Traspaso:</label>          
                    <input type="number" id="offerAmount" value="0" min="0" step="1000">‚Ç¨          
                    <label style="margin-top: 15px;">Jugadores a incluir en el intercambio (opcional):</label>          
                    <select id="playerExchangeSelect" multiple style="min-height: 100px;">          
                        <!-- Opciones cargadas din√°micamente -->          
                    </select>          
                    <button class="btn" onclick="window.submitTransferOffer()">Hacer Oferta de Traspaso</button>          
                </div>          
                <button class="btn danger" style="margin-top: 10px;" onclick="window.endNegotiationUI(false)">Cancelar Negociaci√≥n</button>          
            </div>          
          
        </div>          
    </div>          
          
    <!-- MODAL DE ENTRENAMIENTO -->          
    <div id="trainingModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.closeModal('training')">&times;</span>          
            <h1>Entrenamiento Individual</h1>          
          
            <div class="training-player-info">          
                <h3>Jugador: <span id="trainingPlayerName"></span></h3>          
                <p>Posici√≥n: <span id="trainingPlayerPosition"></span> | Media: <span id="trainingPlayerOverall"></span> | Potencial: <span id="trainingPlayerPotential"></span></p>          
                <p>Atributos actuales:</p>          
                <ul id="trainingPlayerAttributes"></ul>          
            </div>          
          
            <p class="alert alert-info" id="trainingInfoMessage">Selecciona un atributo para que <span id="trainingPlayerNameInfo"></span> se enfoque esta semana.</p>          
            <div id="trainingStaffWarning" class="alert alert-warning" style="display: none;">          
                ‚ö†Ô∏è ¬°Advertencia! No tienes un entrenador f√≠sico contratado. El entrenamiento ser√° menos efectivo.          
            </div>          
             <div id="trainingGkStaffWarning" class="alert alert-warning" style="display: none;">          
                ‚ö†Ô∏è ¬°Advertencia! No tienes un entrenador de porteros contratado. El entrenamiento para POR ser√° menos efectivo.          
            </div>          
          
            <div class="attribute-selection">          
                <p>Seleccionar atributo para entrenar:</p>          
                <div id="attributeRadioButtons">          
                    <!-- Los radio buttons se generar√°n aqu√≠ -->          
                </div>          
            </div>          
          
            <button class="btn" style="margin-top: 20px;" onclick="window.submitTrainingFocus()">Establecer Foco de Entrenamiento</button>          
            <button class="btn danger" style="margin-top: 20px;" onclick="window.closeModal('training')">Cerrar</button>          
        </div>          
    </div>          
          
    <!-- MODAL DE CONTRATAR STAFF -->          
    <div id="hireStaffModal" class="modal">          
        <div class="modal-content">          
            <span class="modal-close" onclick="window.closeModal('hireStaff')">&times;</span>          
            <h1>Contratar Personal: <span id="staffRoleDisplayName"></span></h1>          
            <p>Selecciona un candidato para el puesto de <span id="staffRoleDisplayNameInfo"></span>.</p>          
            <div id="staffCandidatesList">          
                <!-- Candidatos se cargar√°n aqu√≠ -->          
            </div>          
            <button class="btn danger" style="margin-top: 20px;" onclick="window.closeModal('hireStaff')">Cancelar</button>          
        </div>          
    </div>          
          
    <!-- NEW MODAL: Match Result -->          
    <div id="matchResultModal" class="modal">          
        <div class="modal-content">          
            <h1 id="matchResultTitle"></h1>          
            <div id="matchResultDetails"></div>          
            <p id="matchResultMessage"></p>          
        </div>          
    </div>          
          
    <!-- Modales inyectados por scripts (aseg√∫rate de que estos existen para los injectors) -->    
    <div id="loginModal" class="modal"></div>    
    <div id="savedGamesModal" class="modal"></div>    
    <div id="adminModal" class="modal"></div>    
          
    <script type="module">          
        import * as gameLogic from './gameLogic.js';          
        import * as ui from './ui.js';          
        import { TEAMS_DATA, FORMATIONS, POSITIONS, ATTRIBUTES, STAFF_ROLES, PRESEASON_WEEKS } from './config.js';          
        import { getPlayerMarket, getYoungsterMarket } from './players.js';          
          
          
        // --- Funciones globales expuestas para el HTML ---          
        // NOTA: Algunas funciones como populatePlayerExchangeSelect(), updateTacticsDisplay(), updateFacilitiesDisplay(),        
        // updateStaffDisplay(), updateFinanceDisplay(), updateCommercialDisplay() se definen localmente        
        // y luego se adjatan a window. Esto es para mantener la claridad de que no est√°n en el √°mbito global por defecto.        
        
        window.negotiatePlayer = function(playerName) {          
            alert(`La funcionalidad "Negociar" para jugadores de tu plantilla no est√° implementada todav√≠a. Esto ser√≠a para renovaciones, subidas de sueldo, etc.`);          
            console.log(`Intentando negociar con ${playerName}`);          
        };          
          
        // --- Variables y funciones para Drag & Drop (alineaci√≥n) ---          
        let draggedPlayer = null; // Objeto completo del jugador que se arrastra          
          
        window.allowDrop = function(ev) {          
            ev.preventDefault();          
            // Resaltar el slot de destino          
            ev.currentTarget.classList.add('highlight');          
        };          
          
        window.drag = function(ev, playerJson) {          
            const player = JSON.parse(decodeURIComponent(playerJson));          
            if (player.isInjured) {          
                ev.preventDefault(); // No permitir arrastrar jugadores lesionados          
                alert("Los jugadores lesionados no pueden ser alineados.");          
                return;          
            }          
            draggedPlayer = player;          
            ev.dataTransfer.setData("text/plain", playerJson);          
            ev.dataTransfer.effectAllowed = "move"; // Indicar que es un movimiento          
            console.log("Arrastrando:", draggedPlayer.name);          
        };          
          
        window.drop = function(ev, targetSlotId) {          
            ev.preventDefault();          
            ev.currentTarget.classList.remove('highlight'); // Quitar resaltado          
          
            const state = gameLogic.getGameState();          
            let currentLineup = gameLogic.getLineup(); // Obtener la alineaci√≥n actual          
            // let currentSquad = state.squad; // Referencia a toda la plantilla (no se usa directamente aqu√≠)        
          
            const droppedPlayer = draggedPlayer;          
            if (!droppedPlayer || droppedPlayer.isInjured) return; // No permitir soltar lesionados          
          
            const isDroppedPlayerInCurrentLineup = currentLineup.some(p => p && p.name === droppedPlayer.name);          
          
            let newProposedLineup = [...currentLineup]; // Copia de la alineaci√≥n para modificar          
          
            if (targetSlotId.startsWith('pitch-slot-')) { // Soltar en un slot de alineaci√≥n          
                const targetIndex = parseInt(targetSlotId.replace('pitch-slot-', ''));          
                const playerAlreadyInTargetSlot = newProposedLineup[targetIndex];          
          
                if (playerAlreadyInTargetSlot && playerAlreadyInTargetSlot.name === droppedPlayer.name) {          
                    return; // Soltar un jugador sobre s√≠ mismo en el mismo slot          
                }          
          
                if (isDroppedPlayerInCurrentLineup) { // El jugador arrastrado ya estaba en el campo          
                    const sourceIndex = newProposedLineup.findIndex(p => p && p.name === droppedPlayer.name);          
                    if (sourceIndex !== -1) {          
                        newProposedLineup[sourceIndex] = playerAlreadyInTargetSlot; // Mover el que estaba en el destino al origen          
                        newProposedLineup[targetIndex] = droppedPlayer; // Mover el arrastrado al destino          
                    }          
                } else { // El jugador arrastrado viene de reservas          
                    newProposedLineup[targetIndex] = droppedPlayer;          
                }          
            } else if (targetSlotId === 'reservesList') { // Soltar en el √°rea de reservas          
                if (isDroppedPlayerInCurrentLineup) { // El jugador arrastrado ven√≠a del campo          
                    const sourceIndex = newProposedLineup.findIndex(p => p && p.name === droppedPlayer.name);          
                    if (sourceIndex !== -1) {          
                        newProposedLineup[sourceIndex] = null; // Vaciar el slot en el campo          
                    }          
                } else { // El jugador ya estaba en reservas, no hacer nada (o reordenar, pero eso es m√°s complejo)          
                    return;          
                }          
            }          
          
            // Filtrar los nulls de la alineaci√≥n (slots vac√≠os) y reconstruir          
            const finalLineupPlayers = newProposedLineup.filter(p => p !== null);          
          
            gameLogic.setLineup(finalLineupPlayers); // Guardar la nueva alineaci√≥n (puede ser < 11 si se vaci√≥ un slot)          
            window.renderLineupPageUI(); // Volver a renderizar la UI          
            draggedPlayer = null; // Resetear          
        };          
          
        window.dragleave = function(ev) {          
            ev.preventDefault();          
            ev.currentTarget.classList.remove('highlight');          
        };          
          
        // --- NUEVA L√ìGICA DE switchPage para el dise√±o de 4 cuadrantes ---  
        window.switchPage = function(pageId) {  
            // Ocultar el main-layout y mostrar content-pages  
            document.getElementById('mainLayout').style.display = 'none';  
            document.getElementById('contentPages').style.display = 'block';  
          
            // Ocultar todas las p√°ginas y mostrar la solicitada  
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));  
            const targetPage = document.getElementById(pageId);  
            if (targetPage) {  
                targetPage.classList.add('active');  
            } else {  
                console.error(`P√°gina con ID '${pageId}' no encontrada.`);  
            }  
          
            // Actualizar el estado del juego y refrescar UI para la p√°gina  
            const state = gameLogic.getGameState();  
            if (pageId === 'squad') ui.renderSquadList(state.squad, state.team);  
            if (pageId === 'academy') ui.renderAcademyList(state.academy);  
            if (pageId === 'transfers') {  
                window.searchPlayersMarket();  
                window.renderAvailableYoungsters();  
            }  
            if (pageId === 'match') {  
                ui.renderNextMatchCard(state.team, state.nextOpponent, state.week);  
                document.getElementById('lastMatchResult').innerHTML = '';  
                const lastMatch = state.matchHistory[state.matchHistory.length - 1];  
                if (lastMatch) {  
                    document.getElementById('lastMatchResult').innerHTML = `  
                        <div class="alert alert-info">√öltimo resultado: ${lastMatch.home} ${lastMatch.score} ${lastMatch.away}</div>  
                    `;  
                }  
            }  
            if (pageId === 'finance') window.updateFinanceDisplay(state);  
            if (pageId === 'facilities') window.updateFacilitiesDisplay(state);  
            if (pageId === 'commercial') window.updateCommercialDisplay(state);  
            if (pageId === 'staff') window.updateStaffDisplay(state);  
            if (pageId === 'tactics') window.updateTacticsDisplay(state);  
            if (pageId === 'lineup') window.renderLineupPageUI();  
            if (pageId === 'dashboard') gameLogic.markNewsAsRead();  
            if (pageId === 'calendar') ui.renderCalendarPage(state);  
        };  
          
        // --- Funci√≥n para volver al MAIN-LAYOUT ---  
        window.showMainLayout = function() {  
            document.getElementById('contentPages').style.display = 'none';  
            document.getElementById('mainLayout').style.display = 'grid'; // O display: flex; si tu CSS lo requiere  
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); // Ocultar todas las subp√°ginas  
            // No hay bot√≥n activo en el main layout en este dise√±o  
        };  
  
        // A√±adir listeners a los botones del main-layout para switchPage  
        document.addEventListener('DOMContentLoaded', () => {  
            document.querySelectorAll('.main-layout .menu-button').forEach(button => {  
                button.addEventListener('click', (event) => {  
                    const pageId = event.currentTarget.dataset.pageId;  
                    if (pageId) {  
                        window.switchPage(pageId);  
                    }  
                });  
            });  
        });  
        // Modificado para que los botones de las p√°ginas internas vuelvan al main layout  
        window.closePage = function() { // Se podr√≠a usar un bot√≥n de "Atr√°s" en cada p√°gina  
            window.showMainLayout();  
        };  
  
        window.openModal = function(type) {          
            if (type === 'gameMode') {          
                document.getElementById('gameModeModal').classList.add('active');          
            } else if (type === 'selectTeam') {          
                document.getElementById('selectTeamModal').classList.add('active');          
                window.renderTeamSelectors();          
            } else if (type === 'signYoungster') {          
                document.getElementById('signYoungsterModal').classList.add('active');          
                window.renderAvailableYoungsters();          
            } else if (type === 'negotiation') {          
                document.getElementById('negotiationModal').classList.add('active');          
            } else if (type === 'training') {          
                document.getElementById('trainingModal').classList.add('active');          
            } else if (type === 'hireStaff') {          
                document.getElementById('hireStaffModal').classList.add('active');          
            } else if (type === 'matchResult') {          
                document.getElementById('matchResultModal').classList.add('active');          
            } else if (type === 'login') { // Added for login modal  
                document.getElementById('loginModal').classList.add('active');  
            } else if (type === 'savedGames') { // Added for saved games modal  
                document.getElementById('savedGamesModal').classList.add('active');  
            } else if (type === 'admin') { // Added for admin modal  
                document.getElementById('adminModal').classList.add('active');  
            }  
        };          
          
        window.closeModal = function(type) {          
            document.getElementById(type + 'Modal').classList.remove('active');          
        };          
          
        window.startGameMode = function(mode) {          
            window.gameMode = mode;          
            window.closeModal('gameMode');          
            window.openModal('selectTeam');          
        };          
          
        function renderTeamSelectors() { // Definici√≥n local          
            const createTeamButtons = (divisionKey, listId) => {          
                const listElement = document.getElementById(listId);          
                if (!listElement) return;          
          
                const teamsToRender = TEAMS_DATA[divisionKey];          
          
                listElement.innerHTML = teamsToRender.map(team =>          
                    `<button class="btn" onclick="window.selectTeamAndStart('${team}', '${divisionKey}')">          
                        ${team}          
                    </button>`          
                ).join('');          
            };          
          
            createTeamButtons('primera', 'primeraList');          
            createTeamButtons('segunda', 'segundaList');          
            createTeamButtons('rfef_grupo1', 'rfef_grupo1List');          
            createTeamButtons('rfef_grupo2', 'rfef_grupo2List');          
        }          
        window.renderTeamSelectors = renderTeamSelectors; // Hacerla global          
          
        window.selectTeamAndStart = async function(teamName, division) {          
            gameLogic.selectTeamWithInitialSquad(teamName, division, window.gameMode);          
              
            // Load team specific data, including logo and stadium image  
            const teamData = await window.getTeamData(teamName); // Use the global getTeamData  
            const state = gameLogic.getGameState();  
            // Update game state with team specific data for display  
            state.teamData = teamData; // Store it in state for easy access  
            state.stadiumName = teamData.stadiumName;  
            state.stadiumCapacity = teamData.stadiumCapacity;  
            state.stadiumImage = teamData.stadiumImage;  
            state.teamLogo = teamData.logo;  
            gameLogic.updateGameState(state); // Update gameLogic's state  
  
            ui.refreshUI(gameLogic.getGameState());          
            window.closeModal('selectTeam');          
            window.showMainLayout(); // Mostrar el main-layout despu√©s de seleccionar equipo  
        };          
          
        window.searchPlayersMarket = function() {          
            const filters = {          
                searchName: document.getElementById('marketSearchName').value,          
                position: document.getElementById('marketPosition').value,          
                minOverall: parseInt(document.getElementById('marketMinOverall').value) || 0,          
                maxAge: parseInt(document.getElementById('marketMaxAge').value) || 100,          
                transferListed: document.getElementById('marketTransferListed').checked,          
                loanListed: document.getElementById('marketLoanListed').checked          
            };          
            const players = gameLogic.getPlayerMarket(filters);          
            ui.renderPlayerMarketList(players);          
        };          
          
        window.clearPlayerMarketFilters = function() {          
            document.getElementById('marketSearchName').value = '';          
            document.getElementById('marketPosition').value = 'ALL';          
            document.getElementById('marketMinOverall').value = '';          
            document.getElementById('marketMaxAge').value = '';          
            document.getElementById('marketTransferListed').checked = false;          
            document.getElementById('marketLoanListed').checked = false;          
            window.searchPlayersMarket();          
        };          
          
        function renderAvailableYoungsters() { // Definici√≥n local          
            const youngsters = gameLogic.getYoungsterMarket();          
            ui.renderAvailableYoungstersMarket(youngsters);          
        }          
        window.renderAvailableYoungsters = renderAvailableYoungsters; // Hacerla global          
          
        window.fichYoungsterConfirm = function(encodedYoungsterJson) {          
            const youngster = JSON.parse(decodeURIComponent(encodedYoungsterJson));          
            const result = gameLogic.signYoungster(youngster);          
            alert(result.message);          
            ui.refreshUI(gameLogic.getGameState());          
            if (result.success) {          
                window.closeModal('signYoungster');          
            }          
        };          
          
        window.sellPlayerConfirm = function(name) {          
            if (confirm(`¬øEst√°s seguro de que quieres vender a ${name}?`)) {          
                const result = gameLogic.sellPlayer(name);          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
            }          
        };          
          
        window.promoteConfirm = function(name) {          
            if (confirm(`¬øAscender a ${name} a la primera plantilla?`)) {          
                const result = gameLogic.promoteYoungster(name);          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
            }          
        };          
          
        // *** CAMBIO AQUI: L√≥gica de simulaci√≥n con visualizaci√≥n y advertencia ***          
        window.simulateWeek = async function() {          
            const state = gameLogic.getGameState();          
          
            const lineupValidation = gameLogic.validateLineup(state.lineup);          
            if (!lineupValidation.success) {          
                if (state.staff.segundoEntrenador) {          
                    alert(`¬°Advertencia del Segundo Entrenador!\n\nTu alineaci√≥n actual es INV√ÅLIDA:\n${lineupValidation.message}\n\nPor favor, corrige la alineaci√≥n antes de simular la jornada. (La jornada no avanzar√°)`);          
                    gameLogic.addNews(`[Segundo Entrenador - CR√çTICO] Alineaci√≥n inv√°lida: ${lineupValidation.message}. Por favor, corrige.`, 'error');          
                    window.switchPage('lineup'); // Ya no pasamos el elemento  
                    return;          
                } else {          
                    alert(`¬°Alineaci√≥n inv√°lida detectada!\n\n${lineupValidation.message}\n\nTu equipo ser√° penalizado con una derrota 0-3 por alineaci√≥n indebida. (La jornada continuar√°)`);          
                    gameLogic.addNews(`[SISTEMA - ATENCI√ìN] Alineaci√≥n inv√°lida detectada: ${lineupValidation.message}. Derrota 0-3 forzada.`, 'error');          
                }          
            }          
                      
            const simulationResult = gameLogic.simulateFullWeek();          
            ui.refreshUI(gameLogic.getGameState());          
          
            if (simulationResult && simulationResult.myMatch) {          
                const myMatch = simulationResult.myMatch;          
                const matchResultTitle = document.getElementById('matchResultTitle');          
                const matchResultDetails = document.getElementById('matchResultDetails');          
                const matchResultMessage = document.getElementById('matchResultMessage');          
          
                matchResultDetails.innerHTML = `${myMatch.home} ${myMatch.score} ${myMatch.away}`;          
                if (myMatch.home === state.team) {          
                    if (parseInt(myMatch.score.split('-')[0]) > parseInt(myMatch.score.split('-')[1])) {          
                        matchResultTitle.textContent = '¬°VICTORIA!';          
                        matchResultTitle.style.color = '#00ff00';          
                        matchResultMessage.textContent = '';          
                    } else if (parseInt(myMatch.score.split('-')[0]) === parseInt(myMatch.score.split('-')[1])) {          
                        matchResultTitle.textContent = 'EMPATE';          
                        matchResultTitle.style.color = 'orange';          
                        matchResultMessage.textContent = '';          
                    } else {          
                        matchResultTitle.textContent = 'DERROTA';          
                        matchResultTitle.style.color = 'red';          
                        matchResultMessage.textContent = '';          
                    }          
                } else { // Away game          
                    if (parseInt(myMatch.score.split('-')[1]) > parseInt(myMatch.score.split('-')[0])) {          
                        matchResultTitle.textContent = '¬°VICTORIA!';          
                        matchResultTitle.style.color = '#00ff00';          
                        matchResultMessage.textContent = '';          
                    } else if (parseInt(myMatch.score.split('-')[1]) === parseInt(myMatch.score.split('-')[0])) {          
                        matchResultTitle.textContent = 'EMPATE';          
                        matchResultTitle.style.color = 'orange';          
                        matchResultMessage.textContent = '';          
                    } else {          
                        matchResultTitle.textContent = 'DERROTA';          
                        matchResultTitle.style.color = 'red';          
                        matchResultMessage.textContent = '';          
                    }          
                }          
                if (simulationResult.forcedLoss) {          
                    matchResultTitle.textContent = 'DERROTA (por alineaci√≥n indebida)';          
                    matchResultTitle.style.color = 'red';          
                    matchResultMessage.textContent = '¬°Tu equipo perdi√≥ 0-3 debido a una alineaci√≥n inv√°lida!';          
                }          
          
                window.openModal('matchResult');          
                await new Promise(resolve => setTimeout(resolve, 5000));          
                window.closeModal('matchResult');          
            }          
          
            window.showMainLayout(); // Volver al layout principal tras la simulaci√≥n  
        };          
          
        window.startNegotiationUI = function(encodedPlayerJson) {          
            const player = JSON.parse(decodeURIComponent(encodedPlayerJson)); // Asegurarse de que se decodifica correctamente  
            const result = gameLogic.startNegotiation(player);          
            if (result.success) {          
                window.updateNegotiationModal();          
                window.openModal('negotiation');          
            } else {          
                alert('Error: ' + result.message);          
            }          
        };          
    
        window.startPlayerNegotiation = window.startNegotiationUI;    
            
        window.updateNegotiationModal = function() {          
            const state = gameLogic.getGameState();          
            const player = state.negotiatingPlayer;          
          
            if (!player) {          
                window.closeModal('negotiation');          
                return;          
            }          
          
            document.getElementById('negotiationPlayerName').textContent = player.name;          
            document.getElementById('negotiationPlayerNameStep1').textContent = player.name;          
            document.getElementById('negotiationPlayerClub').textContent = player.club;          
            document.getElementById('negotiationPlayerClubStep2').textContent = player.club;          
            document.getElementById('negotiationPlayerPosition').textContent = player.position;          
            document.getElementById('negotiationPlayerAge').textContent = player.age;          
            document.getElementById('negotiationPlayerOverall').textContent = player.overall;          
            document.getElementById('negotiationPlayerPotential').textContent = player.potential;          
            document.getElementById('negotiationPlayerCurrentSalary').textContent = player.salary.toLocaleString('es-ES');          
            document.getElementById('negotiationPlayerValue').textContent = player.value.toLocaleString('es-ES');          
          
            const askingPriceElem = document.getElementById('negotiationPlayerAskingPrice');          
            const loanInfoElem = document.getElementById('negotiationPlayerLoanInfo');          
            if (player.transferListed) {          
                askingPriceElem.style.display = 'block';          
                document.getElementById('negotiationPlayerAskingPriceValue').textContent = player.askingPrice.toLocaleString('es-ES');          
                loanInfoElem.style.display = 'none';          
            } else if (player.loanListed) {          
                askingPriceElem.style.display = 'none';          
                loanInfoElem.style.display = 'block';          
                document.getElementById('negotiationPlayerLoanContribution').textContent = (player.loanWageContribution || 0).toLocaleString('es-ES');          
            } else {          
                askingPriceElem.style.display = 'none';          
                loanInfoElem.style.display = 'none';          
            }          
          
            document.getElementById('negotiationStep1').style.display = 'none';          
            document.getElementById('negotiationStep2').style.display = 'none';          
          
            if (state.negotiationStep === 1) {          
                document.getElementById('negotiationStep1').style.display = 'block';          
                document.getElementById('offeredSalary').value = player.salary;          
                document.getElementById('offeredBonus').checked = false;          
                document.getElementById('offeredCar').checked = false;          
                document.getElementById('offeredHouse').checked = false;          
                document.getElementById('offeredMerchPercent').checked = false;          
                document.getElementById('offeredTicketPercent').checked = false;          
          
            } else if (state.negotiationStep === 2) {          
                document.getElementById('negotiationStep2').style.display = 'block';          
          
                const negotiationLoanOffer = document.getElementById('negotiationLoanOffer');          
                const negotiationTransferOffer = document.getElementById('negotiationTransferOffer');          
          
                negotiationLoanOffer.style.display = 'none';          
                negotiationTransferOffer.style.display = 'none';          
          
                document.getElementById('negotiationClubMessage').textContent = `Est√°s a punto de hacer una oferta a ${player.club} por ${player.name}.`;          
          
                if (player.loanListed) {          
                    negotiationLoanOffer.style.display = 'block';          
                    document.getElementById('loanPlayerSalaryExample').textContent = player.salary.toLocaleString('es-ES');          
                    document.getElementById('loanClubContributionInfo').textContent = (player.loanWageContribution || 0).toLocaleString('es-ES');          
                    document.getElementById('loanWageContribution').value = 50;          
                    document.getElementById('loanWageContributionValue').textContent = '50%';          
                } else if (player.transferListed) {          
                    negotiationTransferOffer.style.display = 'block';          
                    document.getElementById('offerAmount').value = player.askingPrice;          
                    window.populatePlayerExchangeSelect(); // Convertir a global          
                }          
            }          
        };          
          
        window.submitPlayerOffer = function() {          
            const offeredSalary = parseInt(document.getElementById('offeredSalary').value);          
            const offeredBonus = document.getElementById('offeredBonus').checked;          
            const offeredCar = document.getElementById('offeredCar').checked;          
            const offeredHouse = document.getElementById('offeredHouse').checked;          
            const offeredMerchPercent = document.getElementById('offeredMerchPercent').checked;          
            const offeredTicketPercent = document.getElementById('offeredTicketPercent').checked;          
          
            const result = gameLogic.offerToPlayer(offeredSalary, offeredBonus, offeredCar, offeredHouse, offeredMerchPercent, offeredTicketPercent);          
            alert(result.message);          
            if (result.success) {          
                window.updateNegotiationModal();          
            } else {          
                if (result.message.includes('No est√° interesado')) {          
                    window.endNegotiationUI(false);          
                }          
            }          
        };          
          
        function populatePlayerExchangeSelect() {          
            const select = document.getElementById('playerExchangeSelect');          
            select.innerHTML = '';          
            const state = gameLogic.getGameState();          
            state.squad.forEach(p => {          
                const option = document.createElement('option');          
                option.value = p.name;          
                option.textContent = `${p.name} (OVR: ${p.overall}) - VAL: ${p.value.toLocaleString('es-ES')}‚Ç¨`;          
                select.appendChild(option);          
            });          
        }          
        window.populatePlayerExchangeSelect = populatePlayerExchangeSelect; // Hacerla global          
          
        window.submitLoanOffer = function() {          
            const loanWageContribution = parseInt(document.getElementById('loanWageContribution').value);          
            const result = gameLogic.offerToClub(loanWageContribution, [], true);          
            alert(result.message);          
            if (result.success) {          
                window.endNegotiationUI(true);          
            } else {          
                if (result.message.includes('rechazado tu oferta de cesi√≥n')) {          
                    window.endNegotiationUI(false);          
                }          
            }          
        };          
          
        window.submitTransferOffer = function() {          
            const offerAmount = parseInt(document.getElementById('offerAmount').value);          
            const playerExchangeSelect = document.getElementById('playerExchangeSelect');          
            const selectedPlayers = Array.from(playerExchangeSelect.selectedOptions).map(option => option.value);          
          
            const result = gameLogic.offerToClub(offerAmount, selectedPlayers, false);          
            alert(result.message);          
            if (result.success) {          
                window.endNegotiationUI(true);          
            } else {          
                if (result.message.includes('rechazado tu oferta')) {          
                    window.endNegotiationUI(false);          
                }          
            }          
        };          
          
        window.endNegotiationUI = function(success) {          
            gameLogic.endNegotiation(success);          
            window.closeModal('negotiation');          
            ui.refreshUI(gameLogic.getGameState());          
        };          
          
        // --- Funciones de Entrenamiento (UI) ---          
        let currentTrainingPlayerIndex = -1;          
          
        window.setPlayerTrainingFocusUI = function(playerIndex, playerName) {          
            currentTrainingPlayerIndex = playerIndex;          
            const state = gameLogic.getGameState();          
            const player = state.squad[playerIndex];          
          
            if (!player) return;          
          
            document.getElementById('trainingPlayerName').textContent = playerName;          
            document.getElementById('trainingPlayerNameInfo').textContent = playerName;          
            document.getElementById('trainingPlayerPosition').textContent = player.position;          
            document.getElementById('trainingPlayerOverall').textContent = player.overall;          
            document.getElementById('trainingPlayerPotential').textContent = player.potential;          
          
            const attributesList = document.getElementById('trainingPlayerAttributes');          
            attributesList.innerHTML = '';          
            ATTRIBUTES.forEach(attr => {          
                attributesList.innerHTML += `<li style="display: flex; flex-direction: column; align-items: center; border: 1px solid rgba(233, 69, 96, 0.3); padding: 5px; border-radius: 3px;"><strong>${attr}:</strong> ${player[attr] || 0}</li>`;          
            });          
          
            const attributeRadioButtons = document.getElementById('attributeRadioButtons');          
            attributeRadioButtons.innerHTML = '';          
            ATTRIBUTES.forEach(attr => {          
                const checked = (state.trainingFocus.playerIndex === playerIndex && state.trainingFocus.attribute === attr) ? 'checked' : '';          
                attributeRadioButtons.innerHTML += `          
                    <div>          
                        <input type="radio" id="attr_${attr}" name="trainingAttribute" value="${attr}" ${checked}>          
                        <label for="attr_${attr}">${attr}</label>          
                    </div>          
                `;          
            });          
          
            if (!state.staff.entrenador) {          
                document.getElementById('trainingStaffWarning').style.display = 'block';          
            } else {          
                document.getElementById('trainingStaffWarning').style.display = 'none';          
            }          
          
            if (player.position === 'POR' && !state.staff.entrenadorPorteros) {          
                document.getElementById('trainingGkStaffWarning').style.display = 'block';          
            } else {          
                document.getElementById('trainingGkStaffWarning').style.display = 'none';          
            }          
          
            window.openModal('training');          
        };          
          
        window.submitTrainingFocus = function() {          
            const selectedAttribute = document.querySelector('input[name="trainingAttribute"]:checked')?.value;          
            if (!selectedAttribute) {          
                alert('Por favor, selecciona un atributo para entrenar.');          
                return;          
            }          
          
            const result = gameLogic.setTrainingFocus(currentTrainingPlayerIndex, selectedAttribute);          
            alert(result.message);          
            if (result.success) {          
                window.closeModal('training');          
            }          
            ui.refreshUI(gameLogic.getGameState());          
        };          
          
        window.openHireStaffModal = function(role) {          
            document.getElementById('staffRoleDisplayName').textContent = STAFF_ROLES[role].displayName;          
            document.getElementById('staffRoleDisplayNameInfo').textContent = STAFF_ROLES[role].displayName;          
          
            const candidates = gameLogic.generateStaffCandidates(role, true);          
            const list = document.getElementById('staffCandidatesList');          
            const state = gameLogic.getGameState();          
            const existingStaff = state.staff[role];          
          
            let indemnizationMessage = '';          
            if (existingStaff) {          
                const indemnization = existingStaff.salary * 52;          
                indemnizationMessage = `<p class="alert alert-warning">Al contratar a un nuevo ${STAFF_ROLES[role].displayName}, se despedir√° a ${existingStaff.name} con una indemnizaci√≥n de ${indemnization.toLocaleString('es-ES')}‚Ç¨ (salario de un a√±o).</p>`;          
            }          
          
            list.innerHTML = indemnizationMessage + candidates.map((c, idx) => `          
                <div class="staff-candidate">          
                    <div>          
                        <strong>${c.name}</strong> (Nivel ${c.level})<br>          
                        Salario: ${c.salary.toLocaleString('es-ES')}‚Ç¨/semana | Cl√°usula: ${c.clausula.toLocaleString('es-ES')}‚Ç¨          
                    </div>          
                    <button class="btn btn-sm" onclick="window.hireStaffConfirm('${encodeURIComponent(JSON.stringify(c))}')">Contratar</button>          
                </div>          
            `).join('');          
          
            window.openModal('hireStaff');          
        };          
          
        window.hireStaffConfirm = function(encodedCandidateJson) {          
            const candidate = JSON.parse(decodeURIComponent(encodedCandidateJson));          
            const state = gameLogic.getGameState();          
            const existingStaff = state.staff[candidate.role];          
            let confirmationMessage = `¬øEst√°s seguro de que quieres contratar a ${candidate.name} (Nivel ${candidate.level}) por un salario de ${candidate.salary.toLocaleString('es-ES')}‚Ç¨/semana y una cl√°usula de ${candidate.clausula.toLocaleString('es-ES')}‚Ç¨?`;          
          
            if (existingStaff) {          
                const indemnization = existingStaff.salary * 52;          
                confirmationMessage += `\n\nEsto implicar√° despedir a ${existingStaff.name} con una indemnizaci√≥n de ${indemnization.toLocaleString('es-ES')}‚Ç¨ (salario de un a√±o).`;          
            }          
          
            if (confirm(confirmationMessage)) {          
                const result = gameLogic.hireStaffFromCandidates(candidate);          
                alert(result.message);          
                if (result.success) {          
                    window.closeModal('hireStaff');          
                }          
                ui.refreshUI(gameLogic.getGameState());          
                window.updateStaffDisplay(gameLogic.getGameState());          
            }          
        };          
          
        window.updateFormation = function() {          
            const state = gameLogic.getGameState();          
            const newFormation = document.getElementById('formationSelect').value;          
            const updatedState = { ...state, formation: newFormation };          
            gameLogic.updateGameState(updatedState);          
            alert('Formaci√≥n actualizada a ' + FORMATIONS[updatedState.formation].name);          
            window.renderLineupPageUI();          
        };          
          
        window.updateMentality = function() {          
            const state = gameLogic.getGameState();          
            const newMentality = document.getElementById('mentalitySelect').value;          
            const updatedState = { ...state, mentality: newMentality };          
            gameLogic.updateGameState(updatedState);          
            alert('Mentalidad t√°ctica actualizada a ' + updatedState.mentality);          
        };          
          
        function updateTacticsDisplay(state) {          
             const formationSelect = document.getElementById('formationSelect');          
             const mentalitySelect = document.getElementById('mentalitySelect');          
             if(formationSelect) formationSelect.value = state.formation;          
             if(mentalitySelect) mentalitySelect.value = state.mentality;          
        }          
        window.updateTacticsDisplay = updateTacticsDisplay; // Hacerla global          
          
        window.expandStadium = function() {          
            const result = gameLogic.expandStadium();          
            alert(result.message);          
            ui.refreshUI(gameLogic.getGameState());          
            window.updateFacilitiesDisplay(gameLogic.getGameState());          
        };          
          
        window.improveFacilities = function() {          
            const result = gameLogic.improveFacilities();          
            alert(result.message);          
            ui.refreshUI(gameLogic.getGameState());          
            window.updateFacilitiesDisplay(gameLogic.getGameState());          
        };          
          
    function updateFacilitiesDisplay(state) {      
        const currentStadiumCapacity = document.getElementById('currentStadiumCapacity');      
        const currentTrainingLevel = document.getElementById('currentTrainingLevel');      
        const stadiumNameDisplay = document.getElementById('stadiumNameDisplay');      
        const stadiumImageContainer = document.getElementById('stadiumImageContainer');      
              
        if (currentStadiumCapacity) currentStadiumCapacity.textContent = state.stadiumCapacity.toLocaleString('es-ES');      
        if (currentTrainingLevel) currentTrainingLevel.textContent = state.trainingLevel;      
        if (stadiumNameDisplay) stadiumNameDisplay.textContent = state.stadiumName || 'Estadio Municipal';      
              
        // Mostrar imagen del estadio si existe      
        if (stadiumImageContainer && state.stadiumImage) {      
            stadiumImageContainer.innerHTML = `      
                <img src="${state.stadiumImage}"       
                     style="max-width: 100%; max-height: 300px; border: 2px solid #5588FF; border-radius: 10px; display: block;">      
            `;      
        } else if (stadiumImageContainer) {      
            stadiumImageContainer.innerHTML = '<p style="color: #999;">No hay imagen del estadio disponible</p>';      
        }      
    }        
        window.updateFacilitiesDisplay = updateFacilitiesDisplay; // Hacerla global        
      
      
              
        function updateStaffDisplay(state) {          
            Object.keys(STAFF_ROLES).forEach(role => {          
                const staff = state.staff[role];          
                const nameElem = document.getElementById(`staff${role.charAt(0).toUpperCase() + role.slice(1)}Name`);          
                const levelElem = document.getElementById(`staff${role.charAt(0).toUpperCase() + role.slice(1)}Level`);          
                const salaryElem = document.getElementById(`staff${role.charAt(0).toUpperCase() + role.slice(1)}Salary`);          
                const clausulaElem = document.getElementById(`staff${role.charAt(0).toUpperCase() + role.slice(1)}Clausula`);          
                const btnElem = document.getElementById(`btnHire${role.charAt(0).toUpperCase() + role.slice(1)}`);          
          
                if (nameElem) nameElem.textContent = staff ? staff.name : 'No Contratado';          
                if (levelElem) levelElem.textContent = staff ? staff.level : '-';          
                if (salaryElem) salaryElem.textContent = staff ? staff.salary.toLocaleString('es-ES') + '‚Ç¨' : '-';          
                if (clausulaElem) clausulaElem.textContent = staff ? 'N/A' : '-';          
                if (btnElem) {          
                    btnElem.disabled = !!staff;          
                    btnElem.textContent = staff ? 'Contratado' : 'Contratar';          
                }          
            });          
        }          
        window.updateStaffDisplay = updateStaffDisplay; // Hacerla global          
          
        window.setTicketPriceFromInput = function() {          
            const input = document.getElementById('ticketPriceInput');          
            const newPrice = input.value;          
            const result = gameLogic.setTicketPrice(newPrice);          
            if (result.success) {          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
                window.updateFinanceDisplay(gameLogic.getGameState());          
                window.updateCommercialDisplay(gameLogic.getGameState());          
            } else {          
                alert('Error: ' + result.message);          
                input.value = gameLogic.getGameState().ticketPrice;          
            }          
        };          
          
        window.setMerchandisingPriceFromInput = function() {          
            const input = document.getElementById('merchandisingPriceInput');          
            const newPrice = input.value;          
            const result = gameLogic.setMerchandisingPrice(newPrice);          
            if (result.success) {          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
                window.updateFinanceDisplay(gameLogic.getGameState());          
                window.updateCommercialDisplay(gameLogic.getGameState());          
            } else {          
                alert('Error: ' + result.message);          
                input.value = gameLogic.getGameState().merchandisingPrice;          
            }          
        };          
          
        window.updateTicketPriceDisplay = function(value) {          
            document.getElementById('ticketPriceSliderValue').textContent = value;          
        };          
          
        window.setTicketPriceFromSlider = function(value) {          
            const result = gameLogic.setTicketPrice(value);          
            if (result.success) {          
                ui.refreshUI(gameLogic.getGameState());          
                window.updateFinanceDisplay(gameLogic.getGameState());          
            } else {          
                alert('Error: ' + result.message);          
                document.getElementById('ticketPriceSlider').value = gameLogic.getGameState().ticketPrice;          
                document.getElementById('ticketPriceSliderValue').textContent = gameLogic.getGameState().ticketPrice;          
            }          
        };          
          
        window.updateMerchandisingPriceDisplay = function(value) {          
            document.getElementById('merchandisingPriceSliderValue').textContent = value;          
        };          
          
        window.setMerchandisingPriceFromSlider = function(value) {          
            const result = gameLogic.setMerchandisingPrice(value);          
            if (result.success) {          
                ui.refreshUI(gameLogic.getGameState());          
                window.updateFinanceDisplay(gameLogic.getGameState());          
            } else {          
                alert('Error: ' + result.message);          
                document.getElementById('merchandisingPriceSlider').value = gameLogic.getGameState().merchandisingPrice;          
                document.getElementById('merchandisingPriceSliderValue').textContent = gameLogic.getGameState().merchandisingPrice;          
            }          
        };          
          
        function updateFinanceDisplay(state) {          
            document.getElementById('financeWeeklyIncome').textContent = state.weeklyIncome.toLocaleString('es-ES') + '‚Ç¨';          
            document.getElementById('financeWeeklyExpenses').textContent = state.weeklyExpenses.toLocaleString('es-ES') + '‚Ç¨';          
            document.getElementById('financeBalance').textContent = state.balance.toLocaleString('es-ES') + '‚Ç¨';          
            document.getElementById('financeStadiumCapacity').textContent = state.stadiumCapacity.toLocaleString('es-ES');          
          
            let expectedAttendance = Math.floor(state.stadiumCapacity * (0.5 + (state.popularity / 200) - (state.ticketPrice / 100)));          
            expectedAttendance = Math.max(0, Math.min(state.stadiumCapacity, expectedAttendance));          
            document.getElementById('financeExpectedAttendance').textContent = expectedAttendance.toLocaleString('es-ES');          
          
            const ticketPriceInput = document.getElementById('ticketPriceInput');          
            if (ticketPriceInput) ticketPriceInput.value = state.ticketPrice;          
          
            document.getElementById('financePopularity').textContent = state.popularity + '%';          
            document.getElementById('financeFanbase').textContent = state.fanbase.toLocaleString('es-ES');          
            document.getElementById('financeMerchandisingItemsSold').textContent = state.merchandisingItemsSold.toLocaleString('es-ES');          
          
            const merchandisingPriceInput = document.getElementById('merchandisingPriceInput');          
            if (merchandisingPriceInput) merchandisingPriceInput.value = state.merchandisingPrice;          
          
            document.getElementById('financeMerchandisingRevenue').textContent = state.merchandisingRevenue.toLocaleString('es-ES') + '‚Ç¨';          
        }          
        window.updateFinanceDisplay = updateFinanceDisplay; // Hacerla global          
          
        function updateCommercialDisplay(state) {          
            document.getElementById('commercialPopularity').textContent = state.popularity + '%';          
            document.getElementById('commercialFanbase').textContent = state.fanbase.toLocaleString('es-ES');          
            document.getElementById('commercialItemsSold').textContent = state.merchandisingItemsSold.toLocaleString('es-ES');          
            document.getElementById('commercialMerchRevenue').textContent = state.merchandisingRevenue.toLocaleString('es-ES') + '‚Ç¨';          
          
            const ticketPriceSlider = document.getElementById('ticketPriceSlider');          
            const merchandisingPriceSlider = document.getElementById('merchandisingPriceSlider');          
          
            if (ticketPriceSlider) {          
                ticketPriceSlider.value = state.ticketPrice;          
                document.getElementById('currentTicketPrice').textContent = state.ticketPrice;          
                document.getElementById('ticketPriceSliderValue').textContent = state.ticketPrice;          
            }          
            if (merchandisingPriceSlider) {          
                merchandisingPriceSlider.value = state.merchandisingPrice;          
                document.getElementById('currentMerchandisingPrice').textContent = state.merchandisingPrice;          
                document.getElementById('merchandisingPriceSliderValue').textContent = state.merchandisingPrice;          
            }          
        }          
        window.updateCommercialDisplay = updateCommercialDisplay; // Hacerla global          
          
        // --- Funciones de Alineaci√≥n (UI) ---          
        window.renderLineupPageUI = function() {          
            const state = gameLogic.getGameState();          
            const currentFormation = FORMATIONS[state.formation];          
            let lineup = gameLogic.getLineup();          
            let reserves = gameLogic.getReservePlayers();          
          
            const pitchContainer = document.getElementById('pitchContainer');          
            const reservesList = document.getElementById('reservesList');          
                        
            pitchContainer.innerHTML = '';          
            reservesList.innerHTML = '';          
          
            const slotWidth = 18;          
            const slotHeight = 10;          
          
            currentFormation.layout.forEach((posData, index) => {          
                const slot = document.createElement('div');          
                slot.classList.add('pitch-position-placeholder');          
                slot.id = `pitch-slot-${index}`;          
                            
                const leftOffset = posData.x * (100 / 5) + ( (100 / 5) - slotWidth ) / 2;          
                const topOffset = posData.y * (100 / 8) + ( (100 / 8) - slotHeight ) / 2;          
          
                slot.style.left = `${leftOffset}%`;          
                slot.style.top = `${topOffset}%`;          
                slot.style.width = `${slotWidth}%`;          
                slot.style.height = `${slotHeight}%`;          
          
                slot.textContent = posData.pos;          
                slot.ondragover = window.allowDrop;          
                slot.ondragleave = window.dragleave;          
                slot.ondrop = (ev) => window.drop(ev, `pitch-slot-${index}`);          
          
                const playerInSlot = lineup[index];          
                if (playerInSlot) {          
                    const playerDiv = document.createElement('div');          
                    playerDiv.classList.add('pitch-player');          
                    if (playerInSlot.isInjured) playerDiv.classList.add('injured');          
                    playerDiv.draggable = true;          
                    playerDiv.ondragstart = (ev) => window.drag(ev, encodeURIComponent(JSON.stringify(playerInSlot)));          
                    playerDiv.innerHTML = `<span>${playerInSlot.name}</span><span>(${playerInSlot.position}, ${playerInSlot.overall})</span>`;          
                    playerDiv.dataset.playername = playerInSlot.name;          
                    slot.appendChild(playerDiv);          
                }          
                pitchContainer.appendChild(slot);          
            });          
            
            reserves.forEach(player => {          
                const playerDiv = document.createElement('div');          
                playerDiv.classList.add('draggable-player');          
                if (player.isInjured) playerDiv.classList.add('injured');          
                playerDiv.draggable = true;          
                playerDiv.ondragstart = (ev) => window.drag(ev, encodeURIComponent(JSON.stringify(player)));          
                playerDiv.textContent = `${player.name} (${player.overall}) - ${player.position}`;          
                playerDiv.dataset.playername = player.name;          
                reservesList.appendChild(playerDiv);          
            });          
            
            reservesList.ondragover = window.allowDrop;          
            reservesList.ondragleave = window.dragleave;          
            reservesList.ondrop = (ev) => window.drop(ev, 'reservesList');          
            
            const lineupMessageElem = document.getElementById('lineupMessage');          
            if (lineupMessageElem) {          
                const validation = gameLogic.validateLineup(lineup);          
                if (!validation.success) {          
                    lineupMessageElem.className = 'alert alert-warning';          
                    lineupMessageElem.innerHTML = `‚ö†Ô∏è Advertencia: ${validation.message}`;          
                } else {          
                    lineupMessageElem.className = 'alert alert-info';          
                    lineupMessageElem.innerHTML = `Alineaci√≥n actual: ${FORMATIONS[state.formation].name}. Arrastra y suelta jugadores para configurar tu alineaci√≥n.`;          
                }          
            }          
        };          
            
        window.saveLineup = function() {          
            const state = gameLogic.getGameState();          
            const currentFormation = FORMATIONS[state.formation];          
            const newLayout = Array(11).fill(null);          
            
            currentFormation.layout.forEach((posData, index) => {          
                const slot = document.getElementById(`pitch-slot-${index}`);          
                const playerDiv = slot?.querySelector('.pitch-player');          
                if (playerDiv) {          
                    const playerName = playerDiv.dataset.playername;          
                    const fullPlayer = state.squad.find(p => p.name === playerName);          
                    if (fullPlayer) {          
                        newLayout[index] = fullPlayer;          
                    }          
                }          
            });          
            
            const validationResult = gameLogic.validateLineup(newLayout);          
            if (!validationResult.success) {          
                alert(`Error al guardar la alineaci√≥n: ${validationResult.message}`);          
                gameLogic.addNews(`[Segundo Entrenador - ALINEACI√ìN] Error al guardar: ${validationResult.message}`, 'error');          
                window.renderLineupPageUI();          
                return;          
            }          
            
            const result = gameLogic.setLineup(newLayout);          
            if (result.success) {          
                gameLogic.addNews('¬°Alineaci√≥n guardada con √©xito!', 'success');          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
                window.renderLineupPageUI();          
            } else {          
                gameLogic.addNews(`[Segundo Entrenador - ALINEACI√ìN] Error al guardar la alineaci√≥n: ${result.message}`, 'error');          
                alert(`Error al guardar la alineaci√≥n: ${result.message}`);          
            }          
        };          
                  
        window.saveGame = function() {          
            const result = gameLogic.saveToLocalStorage();          
            alert(result.message);          
        };          
            
        window.loadGame = function() {          
            const result = gameLogic.loadFromLocalStorage();          
            if (result.success) {          
                alert(result.message);          
                ui.refreshUI(gameLogic.getGameState());          
                window.showMainLayout(); // Volver al main-layout tras cargar la partida  
            } else {          
                alert(result.message);          
            }          
        };          
            
        window.resetGame = function() {          
            if (confirm('¬øEst√°s seguro de que quieres reiniciar completamente el juego? Toda tu partida se perder√°.')) {          
                gameLogic.resetGame();          
                ui.refreshUI(gameLogic.getGameState()); // Refrescar la UI al reiniciar  
                window.openModal('gameMode'); // Abrir el modal de inicio  
                document.getElementById('mainLayout').style.display = 'none'; // Asegurarse de que el main-layout est√© oculto  
                document.getElementById('contentPages').style.display = 'none'; // Asegurarse de que las p√°ginas est√©n ocultas  
            }          
        };          
            
        document.addEventListener('DOMContentLoaded', () => {          
            const marketPositionSelect = document.getElementById('marketPosition');          
            POSITIONS.forEach(pos => {          
                const option = document.createElement('option');          
                option.value = pos;          
                option.textContent = pos;          
                marketPositionSelect.appendChild(option);          
            });          
            
            const formationSelect = document.getElementById('formationSelect');          
            Object.keys(FORMATIONS).forEach(key => {          
                const option = document.createElement('option');          
                option.value = key;          
                option.textContent = FORMATIONS[key].name;          
                formationSelect.appendChild(option);          
            });          
                        
            const savedStateResult = gameLogic.loadFromLocalStorage();          
            if (savedStateResult.success) {          
                ui.refreshUI(gameLogic.getGameState());          
                window.showMainLayout(); // Mostrar el main-layout si hay partida guardada  
            } else {          
                ui.refreshUI(gameLogic.getGameState()); // Refrescar para estado inicial  
                window.openModal('gameMode');          
                document.getElementById('mainLayout').style.display = 'none'; // Ocultar main-layout inicialmente  
                document.getElementById('contentPages').style.display = 'none'; // Ocultar content-pages inicialmente  
            }          
        });          
      
// Funci√≥n para guardar la partida actual con nombre en la nube      
window.saveCurrentGame = async function() {      
    if (!window.currentUserId) {      
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n para guardar partidas en la nube.');      
        return;      
    }      
    
    const gameName = prompt('Introduce un nombre para tu partida guardada:', `Partida ${new Date().toLocaleDateString()}`);      
    if (!gameName) return;      
    
    // Aseg√∫rate de que gameId es un string v√°lido y √∫nico      
    const gameId = 'game_' + Date.now();      
    const currentGameState = gameLogic.getGameState();      
    
    try {      
        // El userId se pasa expl√≠citamente para mayor claridad      
        const result = await window.saveGameToCloud(window.currentUserId, gameId, gameName, currentGameState);      
        if (result.success) {      
            alert('‚úÖ Partida guardada en la nube correctamente.');      
            // Opcional: Refrescar la lista de partidas guardadas si el modal est√° abierto      
            if (document.getElementById('savedGamesModal')?.classList.contains('active')) {      
                window.openSavedGamesModal();      
            }      
        } else {      
            alert('‚ùå Error al guardar la partida en la nube: ' + (result.error || 'Error desconocido'));      
            console.error('Error al guardar la partida en la nube:', result.error);      
        }      
    } catch (error) {      
        console.error('Error inesperado al guardar la partida:', error);      
        alert('‚ùå Error inesperado al guardar la partida: ' + error.message);      
    }      
};      
              
// Adaptado updateHeaderWithTeamLogo para la nueva estructura del header  
function updateHeaderWithTeamLogo(state) {  
    const teamNameDisplay = document.getElementById('teamNameDisplay');  
    const teamLogoLeft = document.getElementById('teamLogoLeft');  
    const weekNoDisplay = document.getElementById('weekNo');  
    const balanceDisplay = document.getElementById('balanceDisplay');  
  
    if (teamNameDisplay) {  
        teamNameDisplay.textContent = state.team || 'Equipo';  
    }  
    if (teamLogoLeft) {  
        if (state.teamData && state.teamData.logo) {  
            teamLogoLeft.style.backgroundImage = `url('${state.teamData.logo}')`;  
            teamLogoLeft.style.display = 'block'; // Asegurarse de que el div del logo sea visible  
        } else {  
            teamLogoLeft.style.backgroundImage = 'none';  
            teamLogoLeft.style.display = 'block'; // Ocultar si no hay logo  
        }  
    }  
    if (weekNoDisplay) {  
        weekNoDisplay.textContent = state.week;  
    }  
    if (balanceDisplay) {  
        balanceDisplay.textContent = state.balance.toLocaleString('es-ES') + '‚Ç¨';  
    }  
  
    // Actualizar la fecha  
    const today = new Date(); // Aqu√≠ deber√≠as usar la fecha del juego  
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",  
                        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];  
    const weekdayNames = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];  
  
    const currentMonth = document.getElementById('currentDateMonth');  
    const currentDateDay = document.getElementById('currentDateDay');  
    const currentDateWeekday = document.getElementById('currentDateWeekday');  
    const currentDateYear = document.getElementById('currentDateYear');  
  
    if (currentMonth) currentMonth.textContent = monthNames[today.getMonth()];  
    if (currentDateDay) currentDateDay.textContent = today.getDate();  
    if (currentDateWeekday) currentDateWeekday.textContent = weekdayNames[today.getDay()];  
    if (currentDateYear) currentDateYear.textContent = today.getFullYear();  
  
    // Actualizar pretemporada si aplica  
    const preseasonBox = document.getElementById('preseasonBox');  
    const preseasonStatus = document.getElementById('preseasonStatus');  
    if (preseasonBox && preseasonStatus) {  
        if (gameLogic.isPreseason()) { // Asumiendo que tienes una funci√≥n as√≠ en gameLogic  
            preseasonBox.style.display = 'flex'; // Mostrar si es pretemporada  
            preseasonStatus.textContent = `Semana ${state.week} de ${PRESEASON_WEEKS.length}`;  
            preseasonBox.style.backgroundColor = 'rgba(70, 160, 70, 0.6)'; // Verde pretemporada  
            preseasonBox.style.borderColor = '#8BC34A';  
        } else {  
            preseasonBox.style.display = 'none'; // Ocultar si no es pretemporada  
        }  
    }  
}  
              
// Extendemos el refreshUI de ui.js para que se adapte a esta nueva estructura  
const originalRefreshUI = ui.refreshUI;  
ui.refreshUI = function(state) {  
    originalRefreshUI(state); // Llama al refresh original si existe y hace otras cosas  
    updateHeaderWithTeamLogo(state); // Actualiza el header adaptado al nuevo HTML  
};  
  
// Exponer globalmente para injectors      
    window.gameLogic = gameLogic;      
    window.ui = ui;      
    window.TEAMS_DATA = TEAMS_DATA; // IMPORTANTE: Exportar TEAMS_DATA      
    window.ATTRIBUTES = ATTRIBUTES;      
    window.POSITIONS = POSITIONS;      
    window.FORMATIONS = FORMATIONS;      
    console.log('‚úì M√≥dulos cargados y exportados');          
    </script>         
      
    <!-- Injectores para ampliar funcionalidades sin tocar el juego original -->      
<script src="./injector-login-ui.js"></script>  <!-- ‚úÖ ACTIVADO -->      
<script src="./injector-cloud-load.js"></script>    
<script src="./injector-budget.js"></script>      
<script src="./injector-player-arrows.js"></script>    
<script src="./injector-admin-complete.js"></script>      
<script src="./injector-expose-functions.js"></script>     
         
          
</body>          
</html>  
